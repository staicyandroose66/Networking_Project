<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="assets/css/index.css">
    <!-- Navik navigation CSS -->
    <link
        href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">
    <!-- Google fonts -->
    <link
        href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">
    <!-- Google fonts -->

    <title>NavBar</title>
    <style>
        .icon-badge {
            background-color: red;
            font-size: 12px;
            color: white;
            text-align: center;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: absolute;
            top: -14px;
            left: 19%;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <div class="navik-header header-shadow">
        <div class="container">

            <!-- Navik header -->
            <div class="navik-header-container">

                <!--Logo-->
                <div class="logo" data-mobile-logo="assets/images/gym-icon.png"
                    data-sticky-logo="assets/images/gym-icon.png">
                    <a href="#"><img src="assets/images/gym-icon.png" alt="logo" /></a>
                </div>

                <!-- Burger menu -->
                <div class="burger-menu">
                    <div class="line-menu line-half first-line"></div>
                    <div class="line-menu"></div>
                    <div class="line-menu line-half last-line"></div>
                </div>

                <!--Navigation menu-->
                <nav class="navik-menu menu-caret submenu-top-border submenu-scale">
                    <ul class="list-unstyled">
                        <li>
                            <a href="index.html"> <i class="fas fa-home"></i> Home</a>
                        </li>
                        <!-- <li><a href="#">Services</a></li>
                    <li><a href="#">Portfolio</a></li> -->
                        <li class="current-menu"><a href="cart.html"><i class="fa fa-shopping-cart">
                                    <div class="icon-badge">0</div>
                                </i> Cart</a></li>
                        <li id="logged-in-info" class="submenu-right">
                            <a href="#" id="username"> </a>
                            <ul class="list-unstyled">
                                <li><a href="login.html">Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </nav>

            </div>


        </div>
    </div>
    <!-- cart -->

    <div class="cart-section">

        <div class="table-heading">
            <div class="tab">
                <h2 class="cart-product">Product</h2>
                <h2 class="cart-price">Price</h2>
                <h2 class="cart-quantity">Quantity</h2>
                <h2 class="cart-total">Total</h2>
            </div>
            <div class="mobile">
                <h2 class="cart-product">Product Details</h2>
            </div>
        </div>

        <div class="checkout">
            <!--  <button type="button" name="update" id="update">Update</button> -->
            <button type="button" name="checkout" id='do-regiser'>Checkout</button>
            <div class="final-cart-total">
                <h3 class="price">$14.97</h3>
            </div>
        </div>

        <div class="keep-shopping">
            <button type="button" name="keep-shopping" id="keep-shopping">Keep Shopping</button>
        </div>

    </div>

    <!-- modal to show normal messages -->
    <div id="message-modal" class="modal" tabindex="-1" style="margin-top: 8%;z-index: 100001!important;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="width: 90%;">Alert</h5>
                    <button type="button" class="close message-modal-close" data-dismiss="modal" aria-label="Close"
                        style="text-align: right;"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <!-- <p>To add an item to the cart you have to login first.</p> -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary message-modal-close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reserve-modal" class="modal" tabindex="-1"
        style="margin-top: 8%;z-index: 100000!important;overflow: scroll;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="width: 90%;">Reserve</h5>
                    <button type="button" class="close reserve-modal-close" data-dismiss="modal" aria-label="Close"
                        style="text-align: right;"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <label style="text-align: left;">Email</label>
                            <input type="email" id="txt-reserve-email" class="form-control" />
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-md-12">
                            <label style="text-align: left;">Mobile Number</label>
                            <input type="tel" id="txt-reserve-mobile" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary reserve-modal-close">Close</button>
                    <button type="button" class="btn btn-secondary reserve-modal-save">Reserve</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="assets/js/index.js"></script>
    <!-- Navik navigation jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
        var _selectedList = [];
        $(document).ready(function () {
            if (!IsUserLoggedIn()) {
                $('#logged-in-info').hide();
            } else {
                var username = localStorage.getItem('_username');

                if (username == null || username == "") {
                    username = 'User';
                }
                var fullUsername = '<i class="fa fa-user"></i> ' + username
                $('#username').html(fullUsername)
                $('#logged-in-info').show();
                notificationBadgeCounter();
                $('.icon-badge').show();

            }
            populateCart();
            $(document).on('keyup mouseup', '.cart-1-quantity', function () {
                var quantity = $(this).val()
                var pid = $(this).attr('p-id');
                if (quantity < 0) {
                    $(this).val(0)
                    return;
                }
                UpdateProduct(pid, quantity)
            })
            $(document).on('click', '.remove', function () {
                _selectedList = JSON.parse(localStorage.getItem('_selectedList'));
                if (_selectedList == null)
                    _selectedList = [];

                var pid = $(this).attr('p-id');

                var new_arr = $.grep(_selectedList, function (n, i) { // just use arr
                    return n.Id == pid;
                });
                var curr_object = new_arr[0];
                //REMOVED THE CURRENT OBJECT FROM THE LOCAL STORAGE LIST
                _selectedList = $.grep(_selectedList, function (n, i) { // just use arr
                    return n.Id != curr_object.Id;
                });



                localStorage.setItem('_selectedList', JSON.stringify(_selectedList));
                populateCart();
                notificationBadgeCounter();

                //console.log(new_arr)
                // alert(pid)
            })

        });

        function populateCart() {
            $('.table-content').remove();
            _selectedList = JSON.parse(localStorage.getItem('_selectedList'));
            if (_selectedList == null)
                _selectedList = [];
            var sum = 0;
            $.each(_selectedList, function (i, v) {
                console.log(v.Quantity);
                sum = sum + (v.Quantity * v.Price);
                $('.table-heading').after('<div class="table-content"> \
                <div class="cart-product"> \
                    <div class="cart-image-box"> \
                        <img class="cart-images" src="'+ v.Imageurl + '"/> \
                    </div> \
                    <h2 class="cart-item">' + v.Title + '</h2> \
                    <p class="cart-description">' + v.Description + '</p> \
                </div> \
                <div class="cart-price"> \
                    <h3 class="price">$' + v.Price + '</h3> \
                </div> \
                <div class="cart-quantity"> \
                    <input type="number" name="cart-1-quantity" class="cart-1-quantity" p-id="' + v.Id + '" value="' + v.Quantity + '"> \
                </div> \
                <div class="cart-total"> \
                    <h3 class="price">$' + (parseFloat(v.Quantity * v.Price).toFixed(2)) + '</h3> \
                    <button type="button" class="remove" name="remove-3" p-id="' + v.Id + '"><i class="fa fa-trash" aria-hidden="true"></i></button> \
                </div> \
        </div>')

            });
            $('.final-cart-total .price').html(parseFloat(sum).toFixed(2));
        }

        function IsUserLoggedIn() {
            var token = localStorage.getItem('_token');
            if (token == null || token == "") {
                return false;
            } else {
                return true;
            }
        }

        function notificationBadgeCounter() {
            _selectedList = JSON.parse(localStorage.getItem('_selectedList'));
            if (_selectedList == null)
                _selectedList = [];
            var count = _selectedList.length;
            $(".icon-badge").html(count)

        }

        function UpdateProduct(pid, quantity) {
            _selectedList = JSON.parse(localStorage.getItem('_selectedList'));
            if (_selectedList == null)
                _selectedList = [];

            // var pid = $(this).attr('p-id');
            // var quantity = $(this).siblings('.quantity').val();

            $.getJSON('https://n5sm91n1b1.execute-api.eu-west-1.amazonaws.com/v1/getproducts', function (productList) {
                var new_arr = $.grep(productList, function (n, i) { // just use arr
                    return n.Id == pid;
                });
                var curr_object = new_arr[0];
                curr_object.Quantity = quantity;
                //REMOVED THE CURRENT OBJECT FROM THE LOCAL STORAGE LIST
                _selectedList = $.grep(_selectedList, function (n, i) { // just use arr
                    return n.Id != curr_object.Id;
                });

                _selectedList.push(curr_object);

                localStorage.setItem('_selectedList', JSON.stringify(_selectedList));
                //MessageShow('Info', 'The product has been added to the cart');
                notificationBadgeCounter();
                populateCart();
                //console.log(new_arr)
                // alert(pid)

            });
        }


        var _token = "";
        $(document).ready(function () {
            //clearing the token
            localStorage.setItem('_token', '');
            $('.message-modal-close').on('click', function () {
                $('#message-modal').hide();
            })
            $('.reserve-modal-close').on('click', function () {
                $('#reserve-modal').hide();
            })
            $('#do-regiser').on('click', function () {
                $('#reserve-modal').show();
            })

            $('.reserve-modal-save').on('click', function () {
                var email = $('#txt-reserve-email').val()
                var mobile = $('#txt-reserve-mobile').val()
                /* var password = $('#txt-reserve-password').val() */
                /* var otp = $('#txt-reserve-otp').val() */
                if (email == "") {
                    MessageShow('Alert', 'Email field is empty')
                } else if (!isEmail(email)) {
                    MessageShow('Alert', 'Email is invalid')
                } else if (mobile == "") {
                    MessageShow('Alert', 'Moble number is empty')
                } else if (isNaN(mobile)) {
                    MessageShow('Alert', 'Mobile number should be a number')
                } else if (mobile.length != 13) {
                    MessageShow('Alert', 'Mobile number should have 13 digits')
                } else {
                    products_lists = []
                    _selectedList = JSON.parse(localStorage.getItem('_selectedList'));
                    if (_selectedList != null) {
                        $.each(_selectedList, function (i, v) {
                            console.log(v.Quantity);
                            products_lists.push({ "ProductId": v.Id, "Quantity": v.Quantity })

                        })
                    }
                    var formData = {
                        EmailId: email,
                        Phone: mobile,
                        products: products_lists,
                    };

                    $.ajax({
                        type: "POST",
                        url: "https://379wfg6o96.execute-api.eu-west-1.amazonaws.com/v2/reserveproduct",
                        data: JSON.stringify(formData),
                        contentType: "application/json",
                    }).done(function (data, err) {
                        console.log(data, err);
                    });


                    MessageShow('Alert', 'You have reserved successfully!')
                    localStorage.clear();
                    $('#reserve-modal').hide();
                }
            })

            $('#do-login').on('click', function () {
                var username = $('#username').val();
                var password = $('#password').val();
                if (username.trim() == "" || password.trim() == "") {
                    //  alert('Please provide valid credentials.')
                    MessageShow("Alert", "Please provide valid credentials.")
                } else {
                    $.getJSON('assets/json/user.json', function (result) {
                        var isAuthenticated = false;
                        var token = "",
                            name = "";
                        $.each(result.Users, function (i, v) {
                            console.log(v.Email);
                            console.log(v['Email'])
                            if (v.Email == username && v.Password == password) {
                                isAuthenticated = true;
                                token = v.Token;
                                name = v.Name;
                                return;
                            }
                        })
                        if (isAuthenticated) {
                            localStorage.setItem('_token', token);
                            localStorage.setItem('_username', name);
                            window.location.replace("index.html");
                        } else {
                            alert('Invalid credentials')
                        }

                    });

                }
            });
        });

        function isEmail(email) {
            var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            return regex.test(email);
        }

        function IsUserLoggedIn() {
            var token = localStorage.getItem('_token');
            if (token == null || token == "") {
                return false;
            } else {
                return true;
            }
        }

        function MessageShow(heading, body) {
            $('#message-modal .modal-title').html(heading)
            $('#message-modal .modal-body').html('<p>' + body + '</p>')
            $('#message-modal').show();
        }
        function MessageShow(heading, body) {
            $('#message-modal .modal-title').html(heading)
            $('#message-modal .modal-body').html('<p>' + body + '</p>')
            $('#message-modal').show();
        }
        document.getElementById("keep-shopping").onclick = function () {
            location.href = "index.html";
        };
    </script>

</body>

</html>